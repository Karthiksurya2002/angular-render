<div class="">
  <div class="appointment">
    <div class="text-end">
      <mat-icon
        *ngIf="editAdmin"
        class="edit_note"
        matTooltip="Edit Admin"
        (click)="editRequestListImage('image')"
        ><span class="material-symbols-outlined"> edit_note </span></mat-icon
      >
    </div>
    <img [src]="imageUrl" alt="Book Appointment" />
  </div>
  <br /><br />
  <div class="background-container">
    <section class="quickFast">
      <div class="mt-4">
        <h2>My Appointment Summary</h2>
      </div>

      <div class="row text-center" *ngIf="role == 'User'">
        <!-- Row 1 -->
        <div class="col-md-4">
          <h3>{{ data.totalBooked }}</h3>
          <p>Total Booked</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.bookedToday }}</h3>
          <p>Booked Today</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.pending }}</h3>
          <p>Pending Approval</p>
        </div>

        <!-- Row 2 -->
        <div class="col-md-4">
          <h3>{{ data.totalCancelled }}</h3>
          <p>Cancelled Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.totalRescheduled }}</h3>
          <p>Rescheduled Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.completed }}</h3>
          <p>Completed Visits</p>
        </div>
      </div>
      <div class="row text-center" *ngIf="role == 'Doctor'">
        <!-- Row 1 -->
        <div class="col-md-4">
          <h3>{{ data.totalRequests }}</h3>
          <p>Total Requests</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.approvedRequests }}</h3>
          <p>Approved Requests</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.awaitingApproval }}</h3>
          <p>Awaiting Approval</p>
        </div>

        <!-- Row 2 -->
        <div class="col-md-4">
          <h3>{{ data.cancelledRequests }}</h3>
          <p>Cancelled Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.todayRequests }}</h3>
          <p>Today Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.completedConsultations }}</h3>
          <p>Completed Consultations</p>
        </div>
      </div>
      <div class="row text-center" *ngIf="role == 'Admin'">
        <!-- Row 1 : System Overview -->
        <div class="col-md-4">
          <h3>{{ data.totalAppointments }}</h3>
          <p>Total Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.appointmentsToday }}</h3>
          <p>Appointments Today</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.pendingApprovals }}</h3>
          <p>Pending Approvals</p>
        </div>

        <!-- Row 2 : Status Overview -->
        <div class="col-md-4">
          <h3>{{ data.completedAppointments }}</h3>
          <p>Completed Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.cancelledAppointments }}</h3>
          <p>Cancelled Appointments</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.rescheduledAppointments }}</h3>
          <p>Rescheduled Appointments</p>
        </div>

        <!-- Row 3 : Patient Insights -->
        <div class="col-md-4">
          <h3>{{ data.totalPatients }}</h3>
          <p>Total Patients</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.newPatientsToday }}</h3>
          <p>New Patients Today</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.repeatPatients }}</h3>
          <p>Repeat Patients</p>
        </div>

        <!-- Row 4 : Doctor Insights -->
        <div class="col-md-4">
          <h3>{{ data.totalDoctors }}</h3>
          <p>Total Doctors</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.doctorsWithAppointmentsToday }}</h3>
          <p>Doctors With Appointments</p>
        </div>

        <!-- <div class="col-md-4">
          <h3>{{ data.doctorsWithFreeSlots }}</h3>
          <p>Doctors With Free Slots</p>
        </div> -->

        <!-- Row 5 : Operational Health -->
        <div class="col-md-4">
          <h3>{{ data.cancelledAfterApproval }}</h3>
          <p>Cancelled After Approval</p>
        </div>

        <div class="col-md-4">
          <h3>{{ data.reusedSlots }}</h3>
          <p>Reused Slots</p>
        </div>
      </div>
    </section>

    <div class="container-fluid p-4">
      <div class="table-wrapper">
        <!-- Header + Search -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0 fw-semibold">Patient Request List</h3>

          <mat-form-field appearance="outline" class="table-search">
            <mat-label>Search...</mat-label>
            <input
              matInput
              placeholder="Search patient / doctor / OP No"
              (keyup)="applyFilter($event)"
            />
          </mat-form-field>
        </div>

        <!-- TABLE -->
        <div class="table-responsive">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            class="mat-elevation-z2"
          >
            <!-- OP Number -->
            <ng-container matColumnDef="opNumber">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>OP No</th>
              <td mat-cell *matCellDef="let row">
                {{ row.opNumber }}
              </td>
            </ng-container>

            <!-- Patient Name -->
            <ng-container matColumnDef="patientName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Patient Name
              </th>
              <td mat-cell *matCellDef="let row">
                {{ row.patientName }}
              </td>
            </ng-container>

            <!-- Doctor -->
            <ng-container matColumnDef="doctor">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Doctor</th>
              <td mat-cell *matCellDef="let row">
                {{ row.doctor }}
              </td>
            </ng-container>

            <!-- Date -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Preferred Date
              </th>
              <td mat-cell *matCellDef="let row">
                {{ row.date | date: "dd MMM yyyy" }}
              </td>
            </ng-container>
            <!-- Slot -->
            <ng-container matColumnDef="slot">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Slot</th>
              <td mat-cell *matCellDef="let row">
                {{ row.slot }}
              </td>
            </ng-container>
            <ng-container matColumnDef="appointmentCreatedAt">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Appointment Created At
              </th>
              <td mat-cell *matCellDef="let row">
                {{ row.appointmentCreatedAt | date: "dd MMM yyyy, HH:mm" }}
              </td>
            </ng-container>
            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let row">
                <span class="badge-success" *ngIf="row.status === 'Approved'">
                  Approved
                </span>
                <span class="badge-warning" *ngIf="row.status === 'Pending'">
                  Pending
                </span>
                <span
                  class="badge-cancelled"
                  *ngIf="row.status === 'Cancelled'"
                >
                  Cancelled
                </span>
                <span
                  class="badge-cancelled-after-approval"
                  *ngIf="row.status === 'Cancelled_After_Approved'"
                >
                  CancelledAfterApproval
                </span>
                <span
                  class="badge-rescheduled"
                  *ngIf="row.status === 'Rescheduled'"
                >
                  Rescheduled
                </span>
                <span
                  class="badge-Completed"
                  *ngIf="row.status === 'Completed'"
                >
                  Completed
                </span>
                <span class="badge-noShow" *ngIf="row.status === 'NoShow'">
                  No Show
                </span>
              </td>
            </ng-container>

            <!-- Actions -->
            <!-- <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let row">
                <button
                  *ngIf="editAdmin || editDoctor"
                  mat-stroked-button
                  color="primary"
                  class="me-2"
                  (click)="getViewAction(row)"
                >
                  View
                </button>
                <button
                  mat-stroked-button
                  color="warn"
                  [disabled]="
                    row.status === 'Cancelled' ||
                    row.status === 'Cancelled_After_Approved' ||
                    row.status === 'NoShow'
                  "
                  (click)="cancelAppointment(row)"
                >
                  Cancel
                </button>
                <button
                  *ngIf="editAdmin || editDoctor"
                  mat-stroked-button
                  color="warn"
                  [disabled]="
                    row.status === 'Cancelled' ||
                    row.status === 'Approved' ||
                    row.status === 'Cancelled_After_Approved' ||
                    row.status === 'NoShow'
                  "
                  (click)="approveAppointment(row)"
                >
                  Approve
                </button>
                <button
                  *ngIf="editAdmin || editDoctor"
                  mat-stroked-button
                  color="warn"
                  (click)="openNowShow(row)"
                  [disabled]="
                    row.status === 'NoShow' ||
                    row.status === 'Cancelled' ||
                    row.status === 'Cancelled_After_Approved'
                  "
                >
                  No Show
                </button>
                <button
                  mat-stroked-button
                  color="warn"
                  (click)="openCompleteDialog(row)"
                >
                  Completed
                </button>
                <button
                  mat-stroked-button
                  color="warn"
                  (click)="openHistoryDialog(row)"
                >
                  History
                </button>
              </td>
            </ng-container> -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let row">
                <!-- Trigger button -->
                <button mat-icon-button [matMenuTriggerFor]="actionMenu">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <!-- Menu definition -->
                <mat-menu #actionMenu="matMenu">
                  <button
                    mat-menu-item
                    *ngIf="editAdmin || editDoctor"
                    (click)="getViewAction(row)"
                  >
                    <mat-icon>visibility</mat-icon>
                    <span>View</span>
                  </button>

                  <button
                    mat-menu-item
                    (click)="cancelAppointment(row)"
                    [disabled]="
                      row.status === 'Cancelled' ||
                      row.status === 'Cancelled_After_Approved' ||
                      row.status === 'NoShow' ||
                      row.status === 'Completed'
                    "
                  >
                    <mat-icon>cancel</mat-icon>
                    <span>Cancel</span>
                  </button>

                  <button
                    mat-menu-item
                    *ngIf="editAdmin || editDoctor"
                    (click)="approveAppointment(row)"
                    [disabled]="
                      row.status === 'Cancelled' ||
                      row.status === 'Approved' ||
                      row.status === 'Cancelled_After_Approved' ||
                      row.status === 'NoShow' ||
                      row.status === 'Completed'
                    "
                  >
                    <mat-icon>check_circle</mat-icon>
                    <span>Approve</span>
                  </button>

                  <button
                    mat-menu-item
                    *ngIf="editAdmin || editDoctor"
                    (click)="openNowShow(row)"
                    [disabled]="row.status != 'Approved'"
                  >
                    <mat-icon>block</mat-icon>
                    <span>No Show</span>
                  </button>

                  <button
                    *ngIf="editAdmin || editDoctor"
                    mat-menu-item
                    (click)="openCompleteDialog(row)"
                    [disabled]="row.status != 'Approved'"
                  >
                    <mat-icon>done_all</mat-icon>
                    <span>Completed</span>
                  </button>

                  <button mat-menu-item (click)="openHistoryDialog(row)">
                    <mat-icon>history</mat-icon>
                    <span>History</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>
            <!-- Header & Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

            <!-- No Data -->
            <tr *ngIf="dataSource.data.length === 0">
              <td colspan="6" class="text-center py-4 text-muted">
                No records found
              </td>
            </tr>
          </table>
        </div>

        <mat-paginator
          [length]="totalRecords"
          [pageSize]="10"
          [pageSizeOptions]="[5, 10, 20]"
          showFirstLastButtons
        >
        </mat-paginator>
      </div>
    </div>
  </div>
</div>
